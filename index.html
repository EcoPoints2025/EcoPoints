<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EcoPoints ‚Äì Prototipo</title>
<style>
  :root{
    --green:#2e7d32;
    --green-2:#1b5e20;
    --accent:#27ae60;
    --bg1:#a8edea;
    --bg2:#d6f5ec;
    --card:#ffffff;
    --muted:#667085;
    --danger:#c62828;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#111;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .app{
    width:100%;
    max-width:460px;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  header{
    padding:20px 16px;
    text-align:center;
    background:#e8fff3;
    border-bottom:1px solid #e8e8e8;
  }
  header h1{
    margin:6px 0 2px;
    font-size:28px;
    letter-spacing:.3px;
    color:#1f2937;
  }
  header p{margin:0;color:var(--muted)}
  .logo{
    width:84px;height:84px;margin:auto;border-radius:50%;
    display:grid;place-items:center;background:#ffffff;border:8px solid #d8f5e7;
  }
  .container{padding:16px}
  h2{margin:8px 0 12px}
  .btn{
    appearance:none;border:0;cursor:pointer;width:100%;
    background:var(--accent);color:#fff;font-weight:700;
    padding:14px 16px;margin:8px 0;border-radius:12px;font-size:16px;
  }
  .btn.secondary{background:#e6f5ec;color:#1b4332;font-weight:600}
  .btn.outline{background:#fff;border:1px solid #d0d5dd;color:#1f2937}
  .btn.danger{background:var(--danger)}
  .row{display:flex;gap:8px}
  input,select{
    width:100%;padding:12px 14px;border:1px solid #d0d5dd;border-radius:12px;
    font-size:16px;outline:none;
  }
  input:focus,select:focus{border-color:#7fcaa0;box-shadow:0 0 0 3px rgba(39,174,96,.15)}
  .card{
    background:#f9fafb;border:1px solid #eef2f7;border-radius:14px;padding:12px 14px;margin:10px 0;
  }
  .stat{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #e5e7eb}
  .stat:last-child{border-bottom:0}
  small{color:var(--muted)}
  .hidden{display:none !important}
  .hist{
    background:#fff;border:1px solid #e5e7eb;border-radius:12px;
    max-height:220px;overflow-y:auto;padding:10px 12px;font-size:14px;
  }
  .hist p{margin:8px 0}
  .pill{
    display:inline-block;padding:2px 8px;border-radius:999px;background:#e9f7ef;color:#1b5e20;font-weight:600;font-size:12px
  }
  .top-actions{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .link{background:none;border:0;color:#2f855a;text-decoration:underline;cursor:pointer}
  footer{padding:10px 0 18px;text-align:center}
  @media (min-width:480px){
    header h1{font-size:30px}
  }
</style>
</head>
<body>
  <main class="app">
    <header>
      <div class="logo">üå±</div>
      <h1>EcoPoints</h1>
      <p>Puntos ecol√≥gicos</p>
    </header>

    <div class="container">

      <!-- Home -->
      <section id="home">
        <button class="btn" onclick="go('register')">Registrarse</button>
        <button class="btn outline" onclick="go('login')">Iniciar sesi√≥n</button>
      </section>

      <!-- Registro -->
      <section id="register" class="hidden">
        <h2>Crear cuenta</h2>
        <input id="regUser" placeholder="Nombre de usuario" autocomplete="off" />
        <input id="regPass" type="password" placeholder="Contrase√±a" />
        <select id="regRole">
          <option value="alumno">Alumno</option>
          <option value="maestro">Maestro de clase</option>
          <option value="encargado">Maestro encargado de reciclaje</option>
        </select>
        <button class="btn" onclick="register()">Registrarse</button>
        <button class="btn secondary" onclick="go('home')">‚Üê Volver</button>
      </section>

      <!-- Login -->
      <section id="login" class="hidden">
        <h2>Iniciar sesi√≥n</h2>
        <input id="logUser" placeholder="Usuario" autocomplete="username" />
        <input id="logPass" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        <button class="btn" onclick="login()">Entrar</button>
        <button class="btn secondary" onclick="go('home')">‚Üê Volver</button>
      </section>

      <!-- Dashboard Alumno -->
      <section id="dashAlumno" class="hidden">
        <div class="top-actions">
          <span class="pill">Alumno</span>
          <div style="margin-left:auto"></div>
          <button class="link" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
        <h2 id="alumnoNombre">Alumno</h2>

        <div class="card">
          <div class="stat"><strong>EcoPoints</strong> <span id="alEco">0</span></div>
          <div class="stat"><strong>Puntos extra</strong> <span id="alExtra">0</span></div>
        </div>

        <small>Los puntos extra se generan autom√°ticamente: 1 lb = 15 EP, 100 EP = 1 punto extra.</small>

        <h3 style="margin-top:14px">Historial</h3>
        <div class="hist" id="histAlumno"></div>

        <footer>
          <button class="btn danger" onclick="wipeMyData()">Borrar mis datos (este usuario)</button>
        </footer>
      </section>

      <!-- Dashboard Maestro de clase -->
      <section id="dashMaestro" class="hidden">
        <div class="top-actions">
          <span class="pill">Maestro de clase</span>
          <div style="margin-left:auto"></div>
          <button class="link" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
        <h2 id="maestroNombre">Maestro</h2>

        <div class="card">
          <h3>Canjear puntos extra en clase</h3>
          <input id="mBuscar" placeholder="Nombre del alumno" />
          <div class="row">
            <input id="mClase" placeholder="Clase / asignatura" />
            <input id="mPuntos" type="number" inputmode="numeric" placeholder="Puntos extra a usar" />
          </div>
          <button class="btn" onclick="canjear()">Canjear</button>
          <small>Se descuenta del saldo de <em>puntos extra</em> del alumno.</small>
        </div>

        <div class="card">
          <h3>Consulta r√°pida</h3>
          <div class="row">
            <input id="mConsulta" placeholder="Alumno a consultar" />
            <button class="btn outline" onclick="consultarAlumno()">Ver saldos</button>
          </div>
          <div id="mResumen" class="hidden">
            <div class="stat"><strong>EcoPoints</strong> <span id="mEco">0</span></div>
            <div class="stat"><strong>Puntos extra</strong> <span id="mExtra">0</span></div>
          </div>
        </div>

        <h3>Historial de canjes (este maestro)</h3>
        <div class="hist" id="histMaestro"></div>
      </section>

      <!-- Dashboard Encargado -->
      <section id="dashEncargado" class="hidden">
        <div class="top-actions">
          <span class="pill">Encargado de reciclaje</span>
          <div style="margin-left:auto"></div>
          <button class="link" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
        <h2 id="encNombre">Encargado</h2>

        <div class="card">
          <h3>Registrar reciclaje (papel)</h3>
          <input id="eAlumno" placeholder="Nombre del alumno" />
          <div class="row">
            <input id="eLibras" type="number" inputmode="decimal" placeholder="Libras de papel" />
            <button class="btn" onclick="registrarReciclaje()">Registrar ‚ôªÔ∏è</button>
          </div>
          <small>Conversi√≥n autom√°tica: 1 lb = 15 EP; cada 100 EP ‚Üí 1 punto extra (se descuentan los EP usados).</small>
        </div>

        <h3>Historial (este encargado)</h3>
        <div class="hist" id="histEncargado"></div>
      </section>

    </div>
  </main>

<script>
/* ========= Persistencia ========= */
function loadUsers(){ return JSON.parse(localStorage.getItem('ecp_users')||'[]'); }
function saveUsers(arr){ localStorage.setItem('ecp_users', JSON.stringify(arr)); }

/* ========= Navegaci√≥n simple ========= */
function go(id){
  document.querySelectorAll('.container > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
let sessionUser = null;

/* ========= Utilidades ========= */
function findUser(username){
  const users = loadUsers();
  return [users, users.find(u => u.user.toLowerCase()===username.toLowerCase())];
}
function upsertUser(obj){
  const users = loadUsers();
  const i = users.findIndex(u => u.user.toLowerCase()===obj.user.toLowerCase());
  if(i>=0) users[i]=obj; else users.push(obj);
  saveUsers(users);
}

/* ========= Registro / Login ========= */
function register(){
  const user = document.getElementById('regUser').value.trim();
  const pass = document.getElementById('regPass').value;
  const role = document.getElementById('regRole').value;
  if(!user || !pass) return alert('Completa usuario y contrase√±a');

  const [users, exists] = findUser(user);
  if(exists) return alert('Ese usuario ya existe');

  const base = { user, pass, role, historial: [] };
  if(role==='alumno') Object.assign(base, { eco:0, extra:0, histAlumno:[] });
  saveUsers([...users, base]);

  alert('Cuenta creada. Ahora inicia sesi√≥n.');
  document.getElementById('regUser').value='';
  document.getElementById('regPass').value='';
  go('login');
}

function login(){
  const user = document.getElementById('logUser').value.trim();
  const pass = document.getElementById('logPass').value;
  const [users, u] = findUser(user);
  if(!u || u.pass!==pass) return alert('Credenciales inv√°lidas');
  sessionUser = u;
  if(u.role==='alumno') renderAlumno(u);
  else if(u.role==='maestro') renderMaestro(u);
  else renderEncargado(u);
}

function logout(){ sessionUser=null; go('home'); }

/* ========= Alumno ========= */
function renderAlumno(u){
  go('dashAlumno');
  document.getElementById('alumnoNombre').textContent = u.user;
  document.getElementById('alEco').textContent = u.eco ?? 0;
  document.getElementById('alExtra').textContent = u.extra ?? 0;
  const hist = (u.histAlumno||[]).slice().reverse().map(h=>`<p>${h}</p>`).join('');
  document.getElementById('histAlumno').innerHTML = hist || '<p><small>No hay movimientos a√∫n.</small></p>';
}
function wipeMyData(){
  if(!sessionUser || sessionUser.role!=='alumno') return;
  if(!confirm('Esto borrar√° saldos e historial SOLO de este alumno. ¬øContinuar?')) return;
  sessionUser.eco = 0;
  sessionUser.extra = 0;
  sessionUser.histAlumno = [];
  upsertUser(sessionUser);
  renderAlumno(sessionUser);
}

/* ========= Maestro ========= */
function renderMaestro(u){
  go('dashMaestro');
  document.getElementById('maestroNombre').textContent = u.user;
  renderHist('histMaestro', u.historial);
  document.getElementById('mResumen').classList.add('hidden');
  ['mBuscar','mClase','mPuntos','mConsulta'].forEach(id=>document.getElementById(id).value='');
}
function consultarAlumno(){
  const name = document.getElementById('mConsulta').value.trim();
  if(!name) return;
  const [,al] = findUser(name);
  if(!al || al.role!=='alumno') return alert('Alumno no encontrado');
  document.getElementById('mResumen').classList.remove('hidden');
  document.getElementById('mEco').textContent = al.eco ?? 0;
  document.getElementById('mExtra').textContent = al.extra ?? 0;
}
function canjear(){
  if(!sessionUser || sessionUser.role!=='maestro') return;
  const alumnoName = document.getElementById('mBuscar').value.trim();
  const clase = document.getElementById('mClase').value.trim();
  const puntos = parseInt(document.getElementById('mPuntos').value,10);
  if(!alumnoName || !clase || !puntos || puntos<=0) return alert('Completa alumno, clase y puntos v√°lidos');

  const [users, al] = findUser(alumnoName);
  if(!al || al.role!=='alumno') return alert('Alumno no encontrado');
  if((al.extra??0) < puntos) return alert('El alumno no tiene suficientes puntos extra');

  al.extra -= puntos;
  al.histAlumno = al.histAlumno || [];
  al.histAlumno.push(`Canje: -${puntos} punto(s) extra en la clase "${clase}" (por ${sessionUser.user}).`);

  sessionUser.historial.push(`Canje√≥ ${puntos} punto(s) extra de ${al.user} en "${clase}".`);

  upsertUser(al);
  upsertUser(sessionUser);

  renderMaestro(sessionUser);
  alert('Canje aplicado.');
}

/* ========= Encargado ========= */
function renderEncargado(u){
  go('dashEncargado');
  document.getElementById('encNombre').textContent = u.user;
  renderHist('histEncargado', u.historial);
  document.getElementById('eAlumno').value='';
  document.getElementById('eLibras').value='';
}

/* Registro de reciclaje con conversi√≥n autom√°tica y descuento de EP */
function registrarReciclaje(){
  if(!sessionUser || sessionUser.role!=='encargado') return;
  const alumnoName = document.getElementById('eAlumno').value.trim();
  const lbs = parseFloat(document.getElementById('eLibras').value);
  if(!alumnoName || !lbs || lbs<=0) return alert('Ingresa alumno y libras v√°lidas');

  const [users, al] = findUser(alumnoName);
  if(!al || al.role!=='alumno') return alert('Alumno no encontrado');

  const ecoGanados = Math.round(lbs * 15); // 1 lb = 15 EP
  al.eco = (al.eco ?? 0) + ecoGanados;

  // Conversi√≥n autom√°tica: cada 100 EP ‚Üí 1 punto extra, descontando EP usados
  const extrasNuevos = Math.floor(al.eco / 100);
  const ecoADescontar = extrasNuevos * 100;
  if(extrasNuevos > 0){
    al.eco -= ecoADescontar;
    al.extra = (al.extra ?? 0) + extrasNuevos;
  }

  // Historiales
  al.histAlumno = al.histAlumno || [];
  al.histAlumno.push(`Reciclaje: ${lbs.toFixed(2)} lb ‚Üí +${ecoGanados} EP. Auto-conversi√≥n: +${extrasNuevos} extra(s), -${ecoADescontar} EP.`);

  sessionUser.historial.push(`Registr√≥ ${lbs.toFixed(2)} lb para ${al.user}: +${ecoGanados} EP; auto +${extrasNuevos} extra(s).`);

  upsertUser(al);
  upsertUser(sessionUser);

  renderEncargado(sessionUser);
  alert('Reciclaje registrado.');
}

/* ========= Helper historial ========= */
function renderHist(id, arr){
  const el = document.getElementById(id);
  const list = (arr||[]).slice().reverse();
  el.innerHTML = list.length ? list.map(x=>`<p>${x}</p>`).join('') : '<p><small>Sin movimientos.</small></p>';
}
</script>
</body>
</html>
