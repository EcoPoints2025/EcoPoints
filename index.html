<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EcoPoints ‚Äì Prototipo</title>
<style>
  :root{
    --green:#2e7d32;
    --green-2:#1b5e20;
    --accent:#27ae60;
    --bg1:#a8edea;
    --bg2:#d6f5ec;
    --card:#ffffff;
    --muted:#667085;
    --danger:#c62828;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#111;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .app{
    width:100%;
    max-width:480px;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  header{
    padding:20px 16px;
    text-align:center;
    background:#e8fff3;
    border-bottom:1px solid #e8e8e8;
  }
  header h1{ margin:6px 0 2px; font-size:28px; letter-spacing:.3px; color:#1f2937; }
  header p{ margin:0; color:var(--muted) }
  .logo{
    width:84px;height:84px;margin:auto;border-radius:50%;
    display:grid;place-items:center;background:#ffffff;border:8px solid #d8f5e7;
  }
  .container{ padding:16px }
  h2{ margin:8px 0 12px }
  .btn{
    appearance:none;border:0;cursor:pointer;width:100%;
    background:var(--accent);color:#fff;font-weight:700;
    padding:14px 16px;margin:8px 0;border-radius:12px;font-size:16px;
  }
  .btn.secondary{background:#e6f5ec;color:#1b4332;font-weight:600}
  .btn.outline{background:#fff;border:1px solid #d0d5dd;color:#1f2937}
  .btn.danger{background:var(--danger)}
  .btn.small{width:auto;padding:10px 12px;font-size:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select{
    width:100%;padding:12px 14px;border:1px solid #d0d5dd;border-radius:12px;
    font-size:16px;outline:none;background:#fff;
  }
  input:focus,select:focus{border-color:#7fcaa0;box-shadow:0 0 0 3px rgba(39,174,96,.15)}
  .card{
    background:#f9fafb;border:1px solid #eef2f7;border-radius:14px;padding:12px 14px;margin:10px 0;
  }
  .stat{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #e5e7eb}
  .stat:last-child{border-bottom:0}
  small{color:var(--muted)}
  .hidden{display:none !important}
  .hist{
    background:#fff;border:1px solid #e5e7eb;border-radius:12px;
    max-height:240px;overflow-y:auto;padding:10px 12px;font-size:14px;
  }
  .hist p{margin:8px 0}
  .pill{
    display:inline-block;padding:2px 8px;border-radius:999px;background:#e9f7ef;color:#1b5e20;font-weight:600;font-size:12px
  }
  .top-actions{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .link{background:none;border:0;color:#2f855a;text-decoration:underline;cursor:pointer}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (min-width:480px){
    header h1{font-size:30px}
  }
</style>
</head>
<body>
  <main class="app">
    <header>
      <div class="logo">üå±</div>
      <h1>EcoPoints</h1>
      <p>Puntos ecol√≥gicos</p>
    </header>

    <div class="container">

      <!-- Home -->
      <section id="home">
        <button class="btn" onclick="go('login')">Iniciar sesi√≥n</button>
      </section>

      <!-- Login -->
      <section id="login" class="hidden">
        <h2>Iniciar sesi√≥n</h2>
        <input id="lUser" placeholder="Usuario" autocomplete="off" />
        <input id="lPass" type="password" placeholder="Contrase√±a (todos los roles)" />
        <div class="row">
          <input id="lGrado" type="number" inputmode="numeric" placeholder="Grado (solo Alumnos)" />
          <input id="lSeccion" type="number" inputmode="numeric" placeholder="Secci√≥n (solo Alumnos)" />
        </div>
        <div id="lError" style="color:#c62828;font-size:14px"></div>
        <div class="row">
          <button class="btn" onclick="doLogin()">Entrar</button>
          <button class="btn secondary" onclick="go('home')">‚Üê Volver</button>
        </div>
        <small>Alumnos: usuario, <b>contrase√±a</b>, grado y secci√≥n son obligatorios.</small>
      </section>

      <!-- Admin dashboard -->
      <section id="dashAdmin" class="hidden">
        <div class="top-actions">
          <span class="pill">Administrador</span>
          <div style="margin-left:auto"></div>
          <button class="link" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
        <h2>Panel principal</h2>

        <!-- Botones principales -->
        <div class="grid-2">
          <button class="btn small" onclick="toggleCard('cardReg')">Registrar usuario</button>
          <button class="btn small danger" onclick="toggleCard('cardDel')">Borrar usuarios</button>
          <button class="btn small outline" onclick="toggleCard('cardWipe')">Borrar solo datos</button>
          <button class="btn small outline" onclick="toggleCard('cardUpd')">Actualizar grado/secci√≥n</button>
        </div>

        <!-- Registrar -->
        <div id="cardReg" class="card hidden">
          <h3>Registrar usuario</h3>
          <input id="rUser" placeholder="Usuario" />
          <select id="rRole">
            <option value="alumno">Alumno</option>
            <option value="maestro">Maestro de clase</option>
            <option value="encargado">Maestro encargado de reciclaje</option>
          </select>
          <input id="rPass" type="password" placeholder="Contrase√±a (requerida en todos los roles)" />
          <div class="row">
            <input id="rGrado" type="number" inputmode="numeric" placeholder="Grado (solo alumnos)" />
            <input id="rSeccion" type="number" inputmode="numeric" placeholder="Secci√≥n (solo alumnos)" />
          </div>
          <button class="btn" onclick="adminRegister()">Registrar</button>
          <div id="rMsg" style="color:#c62828;font-size:14px"></div>
        </div>

        <!-- Borrar usuarios -->
        <div id="cardDel" class="card hidden">
          <h3>Borrar usuarios</h3>
          <input id="dUser" placeholder="Usuario a borrar" />
          <button class="btn danger" onclick="adminDeleteUser()">Borrar por nombre</button>
          <div class="grid-2" style="margin-top:8px">
            <button class="btn danger small" onclick="adminDeleteByRole('alumno')">Borrar todos los alumnos</button>
            <button class="btn danger small" onclick="adminDeleteByRole('maestro')">Borrar todos los maestros</button>
            <button class="btn danger small" onclick="adminDeleteByRole('encargado')">Borrar todos los encargados</button>
          </div>
          <small>El Administrador no puede borrarse a s√≠ mismo.</small>
        </div>

        <!-- Borrar solo datos -->
        <div id="cardWipe" class="card hidden">
          <h3>Borrar datos de usuarios</h3>
          <input id="wUser" placeholder="Usuario para limpiar datos" />
          <button class="btn outline" onclick="adminWipeUser()">Borrar datos por nombre</button>
          <div class="grid-2" style="margin-top:8px">
            <button class="btn outline small" onclick="adminWipeByRole('alumno')">Borrar datos de alumnos</button>
            <button class="btn outline small" onclick="adminWipeByRole('maestro')">Borrar datos de maestros</button>
            <button class="btn outline small" onclick="adminWipeByRole('encargado')">Borrar datos de encargados</button>
          </div>
        </div>

        <!-- Actualizar grado/secci√≥n -->
        <div id="cardUpd" class="card hidden">
          <h3>Actualizar grado y secci√≥n (Alumno)</h3>
          <input id="uUser" placeholder="Usuario del alumno" />
          <div class="row">
            <input id="uGrado" type="number" inputmode="numeric" placeholder="Nuevo grado" />
            <input id="uSeccion" type="number" inputmode="numeric" placeholder="Nueva secci√≥n" />
          </div>
          <button class="btn outline" onclick="adminUpdateGrade()">Actualizar</button>
          <div id="uMsg" style="color:#c62828;font-size:14px"></div>
        </div>
      </section>

      <!-- Alumno -->
      <section id="dashAlumno" class="hidden">
        <div class="top-actions">
          <span class="pill">Alumno</span>
          <div style="margin-left:auto"></div>
          <button class="link" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
        <h2 id="alNombre">Alumno</h2>
        <div class="card">
          <div class="stat"><strong>Grado</strong> <span id="alGrado">-</span></div>
          <div class="stat"><strong>Secci√≥n</strong> <span id="alSeccion">-</span></div>
          <div class="stat"><strong>EcoPoints</strong> <span id="alEco">0</span></div>
          <div class="stat"><strong>Puntos extra</strong> <span id="alExtra">0</span></div>
        </div>
        <h3>Historial</h3>
        <div class="hist" id="alHist"></div>
      </section>

      <!-- Maestro de clase -->
      <section id="dashMaestro" class="hidden">
        <div class="top-actions">
          <span class="pill">Maestro de clase</span>
          <div style="margin-left:auto"></div>
          <button class="link" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
        <h2 id="mNombre">Maestro</h2>

        <div class="card">
          <h3>Buscar alumno y canjear</h3>
          <input id="mUser" placeholder="Usuario del alumno" />
          <div class="row">
            <input id="mGrado" type="number" inputmode="numeric" placeholder="Grado" />
            <input id="mSeccion" type="number" inputmode="numeric" placeholder="Secci√≥n" />
          </div>
          <div class="row">
            <input id="mClase" placeholder="Clase / asignatura" />
            <input id="mPuntos" type="number" inputmode="numeric" placeholder="Puntos extra a usar" />
          </div>
          <div class="row">
            <button class="btn outline" onclick="maestroConsultar()">Ver saldos</button>
            <button class="btn" onclick="maestroCanjear()">Canjear</button>
          </div>
          <div id="mResumen" class="card hidden" style="margin-top:10px">
            <div class="stat"><strong>EcoPoints</strong> <span id="mEco">0</span></div>
            <div class="stat"><strong>Puntos extra</strong> <span id="mExtra">0</span></div>
          </div>
        </div>

        <h3>Historial (este maestro)</h3>
        <div class="hist" id="mHist"></div>
      </section>

      <!-- Encargado -->
      <section id="dashEncargado" class="hidden">
        <div class="top-actions">
          <span class="pill">Encargado de reciclaje</span>
          <div style="margin-left:auto"></div>
          <button class="link" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
        <h2 id="eNombre">Encargado</h2>

        <div class="card">
          <h3>Registrar reciclaje (papel)</h3>
          <input id="eUser" placeholder="Usuario del alumno" />
          <div class="row">
            <input id="eGrado" type="number" inputmode="numeric" placeholder="Grado" />
            <input id="eSeccion" type="number" inputmode="numeric" placeholder="Secci√≥n" />
          </div>
          <div class="row">
            <input id="eLbs" type="number" inputmode="decimal" placeholder="Libras de papel" />
            <button class="btn" onclick="encRegistrar()">Registrar ‚ôªÔ∏è</button>
          </div>
          <small>1 lb = 15 EP; cada 100 EP ‚Üí 1 punto extra (se descuentan los EP usados).</small>
        </div>

        <h3>Historial (este encargado)</h3>
        <div class="hist" id="eHist"></div>
      </section>

    </div>
  </main>

<script>
/* ======= Tiempo (12h con AM/PM, sin segundos) ======= */
function time12(){
  const d=new Date();
  let h=d.getHours(), m=d.getMinutes();
  const ampm = h>=12 ? 'PM' : 'AM';
  h = h%12; if(h===0) h=12;
  return `${h}:${String(m).padStart(2,'0')} ${ampm}`;
}

/* ======= Persistencia ======= */
function loadUsers(){ return JSON.parse(localStorage.getItem('ecp_users')||'[]'); }
function saveUsers(arr){ localStorage.setItem('ecp_users', JSON.stringify(arr)); }
function ensureAdmin(){
  const users = loadUsers();
  if(!users.find(u=>u.role==='admin')){
    users.push({ user:'Administrador', pass:'AdminEcoIGTLB', role:'admin', historial:[] });
    saveUsers(users);
  }
}
ensureAdmin();

let session = null;

/* ======= Navegaci√≥n ======= */
function go(id){
  document.querySelectorAll('.container > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* ======= Helpers ======= */
function findUser(username){
  const users = loadUsers();
  return [users, users.find(u=>u.user && u.user.toLowerCase()===String(username).toLowerCase())];
}
function upsertUser(obj){
  const users = loadUsers();
  const i = users.findIndex(u=>u.user.toLowerCase()===obj.user.toLowerCase());
  if(i>=0) users[i]=obj; else users.push(obj);
  saveUsers(users);
}
function renderHist(elId, arr){
  const el = document.getElementById(elId);
  const list = (arr||[]).slice().reverse();
  el.innerHTML = list.length ? list.map(x=>`<p>${x}</p>`).join('') : '<p><small>Sin movimientos.</small></p>';
}

/* ======= Login ======= */
function doLogin(){
  const user = document.getElementById('lUser').value.trim();
  const pass = document.getElementById('lPass').value;
  const g    = document.getElementById('lGrado').value.trim();
  const s    = document.getElementById('lSeccion').value.trim();
  const err  = document.getElementById('lError'); err.textContent='';

  if(user==='Administrador'){
    // Admin: requiere contrase√±a
    const [users, admin] = findUser('Administrador');
    if(!admin || admin.role!=='admin') return err.textContent='Admin no encontrado (revisa almacenamiento).';
    if(pass!==admin.pass) return err.textContent='Contrase√±a incorrecta.';
    session = { user: admin.user, role: 'admin' };
    go('dashAdmin');
    return;
  }

  const [users, u] = findUser(user);
  if(!u) return err.textContent='Usuario no existe.';

  if(u.role==='alumno'){
    // Alumnos: usuario + contrase√±a + grado + secci√≥n
    if(!user || !pass || !g || !s) return err.textContent='Alumno: usuario, contrase√±a, grado y secci√≥n son obligatorios.';
    if(u.pass!==pass) return err.textContent='Contrase√±a incorrecta.';
    if(Number(u.grado)!==Number(g) || Number(u.seccion)!==Number(s)) return err.textContent='Grado o secci√≥n incorrectos.';
    session = { user: u.user, role: 'alumno' };
    return renderAlumno(u);
  }

  // Maestro / Encargado: requieren contrase√±a
  if(!pass) return err.textContent='Contrase√±a requerida.';
  if(u.pass!==pass) return err.textContent='Contrase√±a incorrecta.';
  session = { user: u.user, role: u.role };
  if(u.role==='maestro') return renderMaestro(u);
  if(u.role==='encargado') return renderEncargado(u);
}

function logout(){ session=null; go('home'); }

/* ======= Admin ======= */
function toggleCard(id){
  ['cardReg','cardDel','cardWipe','cardUpd'].forEach(cid=>{
    if(cid===id) document.getElementById(cid).classList.toggle('hidden');
    else document.getElementById(cid).classList.add('hidden');
  });
}

function adminRegister(){
  const rUser = document.getElementById('rUser').value.trim();
  const rRole = document.getElementById('rRole').value;
  const rPass = document.getElementById('rPass').value;
  const rGrado= document.getElementById('rGrado').value.trim();
  const rSecc = document.getElementById('rSeccion').value.trim();
  const msg   = document.getElementById('rMsg'); msg.textContent='';

  if(!rUser) return msg.textContent='Usuario requerido.';
  if(!rPass) return msg.textContent='Contrase√±a requerida.';
  const [users, exists] = findUser(rUser);
  if(exists) return msg.textContent='Ese usuario ya existe.';

  if(rRole==='alumno'){
    if(!rGrado || !rSecc) return msg.textContent='Grado y secci√≥n requeridos para alumnos.';
    const obj = { user:rUser, pass:rPass, role:'alumno', grado:Number(rGrado), seccion:Number(rSecc), eco:0, extra:0, histAlumno:[] };
    upsertUser(obj);
  } else if(rRole==='maestro' || rRole==='encargado'){
    const obj = { user:rUser, pass:rPass, role:rRole, historial:[] };
    upsertUser(obj);
  }
  document.getElementById('rUser').value='';
  document.getElementById('rPass').value='';
  document.getElementById('rGrado').value='';
  document.getElementById('rSeccion').value='';
  alert('Usuario registrado.');
}

function adminDeleteUser(){
  const u = document.getElementById('dUser').value.trim();
  if(!u) return alert('Ingresa un usuario.');
  if(u==='Administrador') return alert('No puedes borrar al Administrador.');
  const users = loadUsers();
  const idx = users.findIndex(x=>x.user.toLowerCase()===u.toLowerCase());
  if(idx<0) return alert('Usuario no encontrado.');
  users.splice(idx,1);
  saveUsers(users);
  alert('Usuario borrado.');
}

function adminDeleteByRole(role){
  const users = loadUsers().filter(u=>!(u.role===role) || u.user==='Administrador');
  saveUsers(users);
  alert('Usuarios borrados por rol.');
}

function wipeOnlyData(u){
  if(u.role==='alumno'){ u.eco=0; u.extra=0; u.histAlumno=[]; }
  else if(u.role==='maestro' || u.role==='encargado'){ u.historial=[]; }
  // admin: sin cambios
  return u;
}

function adminWipeUser(){
  const name = document.getElementById('wUser').value.trim();
  if(!name) return alert('Ingresa un usuario.');
  const users = loadUsers();
  const idx = users.findIndex(u=>u.user.toLowerCase()===name.toLowerCase());
  if(idx<0) return alert('Usuario no encontrado.');
  users[idx] = wipeOnlyData(users[idx]);
  saveUsers(users);
  alert('Datos del usuario borrados.');
}

function adminWipeByRole(role){
  const users = loadUsers().map(u=>{
    if(u.role===role) return wipeOnlyData(u);
    return u;
  });
  saveUsers(users);
  alert('Datos borrados por rol.');
}

function adminUpdateGrade(){
  const name = document.getElementById('uUser').value.trim();
  const g = document.getElementById('uGrado').value.trim();
  const s = document.getElementById('uSeccion').value.trim();
  const msg = document.getElementById('uMsg'); msg.textContent='';
  if(!name || !g || !s) return msg.textContent='Usuario, grado y secci√≥n requeridos.';
  const [users, u] = findUser(name);
  if(!u || u.role!=='alumno') return msg.textContent='Alumno no encontrado.';
  u.grado = Number(g); u.seccion = Number(s);
  upsertUser(u);
  alert('Grado y secci√≥n actualizados.');
  document.getElementById('uUser').value='';
  document.getElementById('uGrado').value='';
  document.getElementById('uSeccion').value='';
}

/* ======= Alumno ======= */
function renderAlumno(u){
  go('dashAlumno');
  document.getElementById('alNombre').textContent = u.user;
  document.getElementById('alGrado').textContent  = u.grado ?? '-';
  document.getElementById('alSeccion').textContent= u.seccion ?? '-';
  document.getElementById('alEco').textContent    = u.eco ?? 0;
  document.getElementById('alExtra').textContent  = u.extra ?? 0;
  renderHist('alHist', u.histAlumno);
}

/* ======= Maestro ======= */
function renderMaestro(u){
  go('dashMaestro');
  document.getElementById('mNombre').textContent = u.user;
  renderHist('mHist', u.historial);
  document.getElementById('mResumen').classList.add('hidden');
  ['mUser','mGrado','mSeccion','mClase','mPuntos'].forEach(id=>document.getElementById(id).value='');
}

function maestroFetchAlumno(){
  const aUser = document.getElementById('mUser').value.trim();
  const g = document.getElementById('mGrado').value.trim();
  const s = document.getElementById('mSeccion').value.trim();
  if(!aUser || !g || !s){ alert('Debes ingresar usuario, grado y secci√≥n del alumno.'); return null; }
  const [users, al] = findUser(aUser);
  if(!al || al.role!=='alumno' || Number(al.grado)!==Number(g) || Number(al.seccion)!==Number(s)){
    alert('Alumno no encontrado.'); return null;
  }
  return al;
}

function maestroConsultar(){
  if(!session || session.role!=='maestro') return;
  const al = maestroFetchAlumno(); if(!al) return;
  document.getElementById('mResumen').classList.remove('hidden');
  document.getElementById('mEco').textContent = al.eco ?? 0;
  document.getElementById('mExtra').textContent = al.extra ?? 0;
}

function maestroCanjear(){
  if(!session || session.role!=='maestro') return;
  const clase = document.getElementById('mClase').value.trim();
  const pts = parseInt(document.getElementById('mPuntos').value,10);
  if(!clase || !pts || pts<=0) return alert('Ingresa clase y puntos extra v√°lidos.');
  const al = maestroFetchAlumno(); if(!al) return;

  if((al.extra??0) < pts) return alert('El alumno no tiene suficientes puntos extra.');

  al.extra -= pts;
  al.histAlumno = al.histAlumno || [];
  al.histAlumno.push(`${time12()} ‚Äì Canje: -${pts} punto(s) extra en "${clase}".`);

  const [_, me] = findUser(session.user);
  me.historial = me.historial || [];
  me.historial.push(`${time12()} ‚Äì Canje√≥ ${pts} extra(s) de ${al.user} en "${clase}".`);

  upsertUser(al); upsertUser(me);

  document.getElementById('mResumen').classList.remove('hidden');
  document.getElementById('mEco').textContent = al.eco ?? 0;
  document.getElementById('mExtra').textContent = al.extra ?? 0;
  renderMaestro(me);
  alert('Canje aplicado.');
}

/* ======= Encargado ======= */
function renderEncargado(u){
  go('dashEncargado');
  document.getElementById('eNombre').textContent = u.user;
  renderHist('eHist', u.historial);
  ['eUser','eGrado','eSeccion','eLbs'].forEach(id=>document.getElementById(id).value='');
}

function encRegistrar(){
  if(!session || session.role!=='encargado') return;
  const aUser = document.getElementById('eUser').value.trim();
  const g = document.getElementById('eGrado').value.trim();
  const s = document.getElementById('eSeccion').value.trim();
  const lbs = parseFloat(document.getElementById('eLbs').value);
  if(!aUser || !g || !s) return alert('Debes ingresar usuario, grado y secci√≥n del alumno.');
  if(!lbs || lbs<=0) return alert('Ingresa libras v√°lidas.');

  const [users, al] = findUser(aUser);
  if(!al || al.role!=='alumno' || Number(al.grado)!==Number(g) || Number(al.seccion)!==Number(s)){
    return alert('Alumno no encontrado.');
  }

  const ep = Math.round(lbs * 15); // 1 lb = 15 EP
  al.eco = (al.eco ?? 0) + ep;

  // Historial: registro de reciclaje
  al.histAlumno = al.histAlumno || [];
  al.histAlumno.push(`${time12()} ‚Äì Reciclaje: ${lbs.toFixed(2)} lb ‚Üí +${ep} EP.`);
  const [_, me] = findUser(session.user);
  me.historial = me.historial || [];
  me.historial.push(`${time12()} ‚Äì Registr√≥ ${lbs.toFixed(2)} lb para ${al.user}: +${ep} EP.`);

  // Conversi√≥n autom√°tica a extras descontando EP en bloques de 100
  let nuevosExtras = Math.floor(al.eco / 100);
  for(let i=0;i<nuevosExtras;i++){
    al.eco -= 100;
    al.extra = (al.extra ?? 0) + 1;
    al.histAlumno.push(`${time12()} ‚Äì Auto: -100 EP ‚Üí +1 punto extra.`);
    me.historial.push(`${time12()} ‚Äì Auto en ${al.user}: -100 EP ‚Üí +1 extra.`);
  }

  upsertUser(al); upsertUser(me);
  renderEncargado(me);
  alert('Reciclaje registrado.');
}
</script>
</body>
</html>
